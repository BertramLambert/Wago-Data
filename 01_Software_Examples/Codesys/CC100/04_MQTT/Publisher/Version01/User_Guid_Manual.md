# User Guide: WAGO MQTT Publisher Implementation

> [!TIP]
> **Technical Document Info:**
> ![Platform](https://img.shields.io/badge/Platform-WAGO%20PFC-ee0000) ![Protocol](https://img.shields.io/badge/Protocol-MQTT%20Publish-blue) ![Library](https://img.shields.io/badge/Library-WagoAppNativeMQTT-orange) ![Status](https://img.shields.io/badge/Status-Native%20Driver-brightgreen)

---

## ðŸ“– ç›®éŒ„ (Table of Contents)
1. [WBM é€£ç·šé—œè¯è¨­å®š](#1-wbm-é€£ç·šé—œè¯è¨­å®š)
2. [ç¨‹å¼æ ¸å¿ƒé‚è¼¯ (Logic Overview)](#2-ç¨‹å¼æ ¸å¿ƒé‚è¼¯-logic-overview)
3. [è®Šæ•¸èˆ‡åƒæ•¸èªªæ˜Ž (Interface)](#3-è®Šæ•¸èˆ‡åƒæ•¸èªªæ˜Ž-interface)
4. [ç™¼é€æ©Ÿåˆ¶è©³è§£ (Transmission Mechanism)](#4-ç™¼é€æ©Ÿåˆ¶è©³è§£-transmission-mechanism)
5. [è½‰ PDF èˆ‡æ“ä½œå»ºè­°](#5-è½‰-pdf-èˆ‡æ“ä½œå»ºè­°)

---

## 1. WBM é€£ç·šé—œè¯è¨­å®š

æœ¬ç¨‹å¼ä½¿ç”¨ **Native MQTT** é©…å‹•ï¼Œå…¶å»ºæ§‹å­ä¸­çš„ ID åƒæ•¸å¿…é ˆèˆ‡ WAGO æŽ§åˆ¶å™¨ç¶²é ä»‹é¢ (WBM) ä¸­çš„è¨­å®šä¸€è‡´ã€‚

* **ID å®šç¾©**: ç¨‹å¼ç¢¼ä¸­ `FbPublishMQTT_2(1)` çš„ `(1)` ä»£è¡¨å°æ‡‰ WBM ä¸­çš„ **Connection 1**ã€‚
* **ç¶²é é…ç½®ç¢ºèª**: 
    * å‰å¾€ **Cloud Connectivity** > **Connection 1**ã€‚
    * ç¢ºèª **Enabled** å·²å‹¾é¸ã€‚
    * ç¢ºèª Broker Hostname èˆ‡ Port æ­£ç¢ºç„¡èª¤ã€‚



---

## 2. ç¨‹å¼æ ¸å¿ƒé‚è¼¯ (Logic Overview)

æœ¬ç¨‹å¼ `mqtt_published` å¯¦ç¾äº†æ‰‹å‹•è§¸ç™¼çš„ MQTT è³‡æ–™ç™¼é€åŠŸèƒ½ï¼Œä¸¦é€éŽåº•å±¤æŒ‡æ¨™æ¬ç§»è§£æ±ºäº†å¸¸è¦‹çš„ç·¨è­¯æ¬Šé™èˆ‡è³‡æ–™æ ¼å¼å•é¡Œã€‚

### ä¸»è¦åŠŸèƒ½ï¼š
1. **é€£ç·šç‹€æ…‹å³æ™‚ç›£æŽ§**ï¼šé€éŽ `fbMqttStatus` è‡ªå‹•ç²å–æŽ§åˆ¶å™¨çš„é›²ç«¯é€£ç·šç‹€æ…‹ã€‚
2. **æŒ‡æ¨™å¼è³‡æ–™æ¬ç§»**ï¼šä¸ä½¿ç”¨é«˜éšŽå‡½æ•¸ï¼Œç›´æŽ¥æ“ä½œ `POINTER TO BYTE` å°‡ `STRING` å…§å®¹ç²¾ç¢ºæ¬ç§»è‡³ `BYTE ARRAY` ç·©è¡å€ï¼Œè¦é¿ C0041 æ¬Šé™éŒ¯èª¤ã€‚
3. **ç©©å®šè§¸ç™¼æ©Ÿåˆ¶**ï¼šå¼•å…¥ `xPublishTrigger` ä¸­é–“è®Šæ•¸ï¼Œç¢ºä¿è§¸ç™¼è¨Šè™Ÿåœ¨ `fbPublish.xBusy` æœŸé–“ä¿æŒç©©å®šã€‚

---

## 3. è®Šæ•¸èˆ‡åƒæ•¸èªªæ˜Ž (Interface)

### ðŸ“¥ æ ¸å¿ƒæŽ§åˆ¶è®Šæ•¸
| è®Šæ•¸åç¨± | é¡žåž‹ | èªªæ˜Ž |
| :--- | :--- | :--- |
| `sMessage` | `STRING(255)` | **å¾…ç™¼é€å…§å®¹**ï¼šä½¿ç”¨è€…åœ¨æ­¤è¼¸å…¥è¦ç™¼é€çš„æ–‡å­—è¨Šæ¯ã€‚ |
| `xSend` | `BOOL` | **æ‰‹å‹•ç™¼é€é–‹é—œ**ï¼šé»žæ“Šç‚º TRUE è§¸ç™¼æ¬ç§»èˆ‡ç™¼é€æµç¨‹ã€‚ |
| `xConnected` | `BOOL` | **ç‹€æ…‹ç‡ˆ**ï¼šé¡¯ç¤ºç›®å‰ PLC æ˜¯å¦å·²æˆåŠŸé€£æŽ¥è‡³ MQTT Brokerã€‚ |

### ðŸ“¤ MQTT é…ç½®åƒæ•¸
* **Topic**: `CC100-751-9301` (å¯ä¾å°ˆæ¡ˆéœ€æ±‚ä¿®æ”¹)ã€‚
* **QoS**: `QOS1` (è‡³å°‘é€é”ä¸€æ¬¡)ï¼Œç¢ºä¿æ•¸æ“šå‚³è¼¸å¯é æ€§ã€‚
* **Retain**: `TRUE` (ä¿ç•™è¨Šæ¯)ï¼ŒBroker æœƒä¿å­˜æœ€å¾Œä¸€ç­†æ•¸å€¼ä¾›æ–°åŠ å…¥çš„è¨‚é–±è€…æŸ¥çœ‹ã€‚

---

## 4. ç™¼é€æ©Ÿåˆ¶è©³è§£ (Transmission Mechanism)

### è³‡æ–™æ¬ç§»æµç¨‹ (Buffer Handling)
ç”±æ–¼ `FbPublishMQTT_2` éœ€è¦ `ARRAY OF BYTE` ä½œç‚ºè¼¸å…¥ï¼Œç¨‹å¼é€éŽä»¥ä¸‹è¿´åœˆå®Œæˆæ ¼å¼è½‰æ›ï¼š
1. è¨ˆç®—å­—ä¸²é•·åº¦ `LEN(sMessage)`ã€‚
2. ä½¿ç”¨æŒ‡æ¨™ `pString` é€ä¸€è®€å–å­—ä¸²è¨˜æ†¶é«”å…§å®¹ã€‚
3. å¡«å…¥ `aBuffer` é™£åˆ—ï¼Œä¸¦å°‡å‰©é¤˜ç©ºé–“è£œ 0ï¼ˆNull-terminated è™•ç†ï¼‰ã€‚

### è§¸ç™¼æµç¨‹åœ–
1. `xSend` è¢«è§¸ç™¼ âž” 2. è³‡æ–™æ¬ç§»è‡³ç·©è¡å€ âž” 3. `xPublishTrigger` è½‰ç‚º TRUE âž” 4. `fbPublish` åŸ·è¡Œç™¼é€ âž” 5. é€é”å¾Œå›žå ± `xBusy = FALSE` âž” 6. é‡ç½®è§¸ç™¼è¨Šè™Ÿã€‚



---

## 5. è½‰ PDF èˆ‡æ“ä½œå»ºè­°

### è½‰ PDF æŠ€å·§ï¼š
* **å½©è‰²æ¨™ç±¤**ï¼šåˆ—å° PDF æ™‚ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å‹¾é¸ **ã€ŒèƒŒæ™¯åœ–å½¢ã€**ï¼Œç¢ºä¿é ‚éƒ¨çš„ Version èˆ‡ Status æ¨™ç±¤é¡¯ç¤ºé¡è‰²ã€‚
* **ä»£ç¢¼å€å¡Š**ï¼šè‹¥éœ€å°‡ PLC Code é™„åœ¨æ‰‹å†Šå¾Œæ–¹ï¼Œå»ºè­°ç¶­æŒ Markdown çš„ç°åº•æ ¼å¼ï¼Œæ›´æ˜“æ–¼é–±è®€ã€‚

### èª¿è©¦æŒ‡å— (Troubleshooting)ï¼š
* **è¨Šæ¯é€ä¸å‡º**ï¼šæª¢æŸ¥ `udiSize` æ˜¯å¦å¤§æ–¼ 0ã€‚è‹¥ `dwSize` ç‚º 0ï¼Œç™¼é€å°‡è¢«è¦–ç‚ºç„¡æ•ˆã€‚
* **ç‹€æ…‹ç‡ˆä¸äº®**ï¼šç¢ºèªç¶²é  WBM çš„ Cloud platform æ˜¯å¦é¸ç‚º `MQTT AnyCloud`ã€‚
* **è³‡æ–™äº‚ç¢¼**ï¼šç¢ºèªè¨‚é–±ç«¯ï¼ˆå¦‚ MQTT.fx æˆ– Node-REDï¼‰æ˜¯å¦ä½¿ç”¨ UTF-8 ç·¨ç¢¼è§£è®€å­—ä¸²ã€‚

---
> **Manual Generated for WAGO MQTT System Integration**